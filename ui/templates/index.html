<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yakutan 控制面板</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>🎤 Yakutan 控制面板</h1>
            <div class="status-indicator">
                <span id="status-text">服务未运行</span>
                <div class="status-dot" id="status-dot"></div>
            </div>
        </header>

        <main>
            <!-- 状态消息 - 跨两栏 -->
            <!-- <div id="message" class="message" style="grid-column: 1 / -1;"></div> -->

            <!-- 左栏 -->
            <div class="column-left">
                <!-- 服务控制区域 -->
                <section class="card">
                    <h2>服务控制</h2>
                    <div class="control-buttons">
                        <div class="control-buttons-left">
                            <button id="start-btn" class="btn btn-success" onclick="startService()">启动服务</button>
                            <button id="stop-btn" class="btn btn-danger" onclick="stopService()" disabled>停止服务</button>
                        </div>
                        <div class="control-buttons-right">
                            <button id="reset-btn" class="btn btn-warning" onclick="resetToDefaults()">恢复默认设置</button>
                        </div>
                    </div>
                    <small class="form-text" style="margin-top: 10px; display: block;">所有配置将自动保存在浏览器本地</small>
                </section>

                <!-- 基本设置 -->
                <section class="card">
                    <h2>基本设置</h2>
                    
                    <!-- 一行两个开关：启用翻译和输出中间结果 -->
                    <div class="switch-row">
                        <div class="form-group">
                            <label class="switch-label">
                                <span>启用翻译</span>
                                <label class="switch">
                                    <input type="checkbox" id="enable-translation" onchange="onSettingChange(); toggleTranslationOptions()">
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label class="switch-label">
                                <span>输出中间结果</span>
                                <label class="switch">
                                    <input type="checkbox" id="show-partial-results" onchange="onSettingChange()">
                                    <span class="slider"></span>
                                </label>
                            </label>
                            <small class="form-text">不推荐在开启翻译时使用</small>
                        </div>
                    </div>

                    <div id="translation-options">
                        <div class="form-group">
                            <label for="target-language">目标语言</label>
                            <div class="language-input-group">
                                <input type="text" id="target-language" class="form-control language-code-input" placeholder="ja" onblur="onSettingChange()">
                                <select id="target-language-select" class="form-control language-select" onchange="applyLanguageSelection('target-language')">
                                    <option value="">-- 快速选择 --</option>
                                    <option value="zh">中文 (zh)</option>
                                    <option value="zh-CN">简体中文 (zh-CN)</option>
                                    <option value="zh-TW">繁体中文 (zh-TW)</option>
                                    <option value="en">英语 (en)</option>
                                    <option value="en-US">美式英语 (en-US)</option>
                                    <option value="en-GB">英式英语 (en-GB)</option>
                                    <option value="ja">日语 (ja)</option>
                                    <option value="ko">韩语 (ko)</option>
                                    <option value="es">西班牙语 (es)</option>
                                    <option value="fr">法语 (fr)</option>
                                    <option value="de">德语 (de)</option>
                                    <option value="ru">俄语 (ru)</option>
                                    <option value="ar">阿拉伯语 (ar)</option>
                                    <option value="pt">葡萄牙语 (pt)</option>
                                    <option value="it">意大利语 (it)</option>
                                </select>
                            </div>
                            <small class="form-text">可直接输入语言代码，或从下拉列表快速选择</small>
                        </div>

                        <div class="form-group">
                            <label for="fallback-language">备用语言（当源语言与目标语言相同时使用）</label>
                            <div class="language-input-group">
                                <input type="text" id="fallback-language" class="form-control language-code-input" placeholder="en" onblur="onSettingChange()">
                                <select id="fallback-language-select" class="form-control language-select" onchange="applyLanguageSelection('fallback-language')">
                                    <option value="">-- 快速选择 --</option>
                                    <option value="">禁用</option>
                                    <option value="zh">中文 (zh)</option>
                                    <option value="zh-CN">简体中文 (zh-CN)</option>
                                    <option value="zh-TW">繁体中文 (zh-TW)</option>
                                    <option value="en">英语 (en)</option>
                                    <option value="en-US">美式英语 (en-US)</option>
                                    <option value="en-GB">英式英语 (en-GB)</option>
                                    <option value="ja">日语 (ja)</option>
                                    <option value="ko">韩语 (ko)</option>
                                    <option value="es">西班牙语 (es)</option>
                                    <option value="fr">法语 (fr)</option>
                                    <option value="de">德语 (de)</option>
                                    <option value="ru">俄语 (ru)</option>
                                    <option value="ar">阿拉伯语 (ar)</option>
                                    <option value="pt">葡萄牙语 (pt)</option>
                                    <option value="it">意大利语 (it)</option>
                                </select>
                            </div>
                            <small class="form-text">可直接输入语言代码，留空则禁用备用语言</small>
                        </div>
                    </div>
                </section>

                <!-- 翻译API设置 -->
                <section class="card">
                    <div class="collapsible-header" onclick="toggleCollapsible('translation-api')">
                        <h2>翻译API设置</h2>
                        <span class="collapse-icon" id="translation-api-icon">▼</span>
                    </div>
                    <div class="collapsible-content" id="translation-api">
                        <div class="form-group">
                            <label for="translation-api-type">翻译API</label>
                            <select id="translation-api-type" class="form-control" onchange="handleTranslationApiChange(event)">
                                <option value="deepl">DeepL（高质量）</option>
                                <option value="google_dictionary">Google Dictionary（免费，更快，请注意网络连通性）</option>
                                <option value="google_web">Google Web（免费，备用，请注意网络连通性）</option>
                                <option value="openrouter">OpenRouter（LLM）</option>
                                <option value="openrouter_streaming">OpenRouter Streaming (流式翻译)</option>
                            </select>
                            <small id="translation-api-warning" class="form-text" style="color: #e74c3c; display: none;"></small>
                        </div>
                        
                        <div class="form-group" id="translate-partial-results-group" style="display: none;">
                            <label class="switch-label">
                                <span>流式翻译部分结果</span>
                                <label class="switch">
                                    <input type="checkbox" id="translate-partial-results" onchange="onSettingChange()">
                                    <span class="slider"></span>
                                </label>
                            </label>
                            <small class="form-text">实时翻译未完成的句子（仅 OpenRouter Streaming 支持）</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="switch-label">
                                <span>启用反向翻译</span>
                                <label class="switch">
                                    <input type="checkbox" id="enable-reverse-translation" onchange="onSettingChange()">
                                    <span class="slider"></span>
                                </label>
                            </label>
                            <small class="form-text">总是使用 Google Dictionary API，请注意网络连通性</small>
                        </div>
                    </div>
                </section>
            </div>

            <!-- 右栏 -->
            <div class="column-right">
                <div id="message" class="message"></div>

                <!-- API Keys配置 -->
                <section class="card">
                    <div class="collapsible-header" onclick="toggleCollapsible('api-keys')">
                        <h2>API Keys 配置</h2>
                        <span class="collapse-icon" id="api-keys-icon">▼</span>
                    </div>
                    <div class="collapsible-content" id="api-keys">
                        <div class="api-key-group">
                            <label for="dashscope-api-key">
                                阿里云 DashScope API Key 
                                <span style="color: #e74c3c; font-weight: bold;">*必需</span>
                            </label>
                            <input type="password" id="dashscope-api-key" class="form-control" placeholder="sk-..." required>
                            <small class="form-text">
                                Qwen 和 DashScope 语音识别均需要此 Key。
                                <a href="https://bailian.console.aliyun.com/?tab=model#/model-market/detail/fun-asr-realtime" target="_blank">获取API Key →</a>
                            </small>
                        </div>
                        
                        <div class="api-key-group">
                            <label for="deepl-api-key">DeepL API Key (可选，用于翻译)</label>
                            <input type="password" id="deepl-api-key" class="form-control" placeholder="...">
                            <small class="form-text">
                                <a href="https://www.deepl.com/en/pro-api" target="_blank">获取API Key →</a>
                            </small>
                        </div>
                        
                        <div class="api-key-group">
                            <label for="openrouter-api-key">OpenRouter API Key (可选，用于LLM翻译)</label>
                            <input type="password" id="openrouter-api-key" class="form-control" placeholder="sk-or-...">
                            <small class="form-text">
                                <a href="https://openrouter.ai/" target="_blank">获取API Key →</a>
                            </small>
                        </div>
                    </div>
                </section>

                <!-- 语音识别设置 -->
                <section class="card">
                    <div class="collapsible-header" onclick="toggleCollapsible('asr-settings')">
                        <h2>语音识别设置</h2>
                        <span class="collapse-icon" id="asr-settings-icon">▼</span>
                    </div>
                    <div class="collapsible-content" id="asr-settings">
                        <div class="form-group">
                            <label for="asr-backend">识别后端</label>
                            <select id="asr-backend" class="form-control" onchange="onSettingChange()" data-restart-required="true">
                                <option value="qwen">Qwen3 ASR（推荐）</option>
                                <option value="dashscope">Fun-ASR</option>
                            </select>
                        </div>

                        <div class="switch-row">
                            <div class="form-group">
                                <label class="switch-label">
                                    <span>游戏静音时暂停转录</span>
                                    <label class="switch">
                                        <input type="checkbox" id="enable-mic-control" onchange="onSettingChange()">
                                        <span class="slider"></span>
                                    </label>
                                </label>
                                <small class="form-text">第一次解除静音后开始转录</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="switch-label">
                                    <span>启用热词</span>
                                    <label class="switch">
                                        <input type="checkbox" id="enable-hot-words" onchange="onSettingChange()" data-restart-required="true">
                                        <span class="slider"></span>
                                    </label>
                                </label>
                                <small class="form-text">提高特定词汇的识别准确度</small>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="mute-delay">静音延迟（秒）</label>
                            <input type="number" id="mute-delay" class="form-control" min="0" max="5" step="0.1" value="0.2" onchange="onSettingChange()">
                            <small class="form-text">静音后延迟停止识别的时间，防止漏掉最后一个字</small>
                        </div>
                    </div>
                </section>

                <!-- 高级设置（折叠） -->
                <section class="card">
                    <div class="collapsible-header" onclick="toggleCollapsible('advanced-settings')">
                        <h2>高级设置</h2>
                        <span class="collapse-icon collapsed" id="advanced-settings-icon">▶</span>
                    </div>
                    <div class="collapsible-content collapsed" id="advanced-settings">
                        <!-- VAD设置 -->
                        <div class="subsection">
                            <h3>VAD（语音活动检测）设置 - 仅Qwen后端</h3>
                            
                            <div class="form-group">
                                <label class="switch-label">
                                    <span>启用VAD</span>
                                    <label class="switch">
                                        <input type="checkbox" id="enable-vad" onchange="onSettingChange()" data-restart-required="true">
                                        <span class="slider"></span>
                                    </label>
                                </label>
                                <small class="form-text">自动检测语音结束并断句</small>
                            </div>

                            <div class="form-group">
                                <label for="vad-threshold">VAD阈值（0.0-1.0）</label>
                                <input type="number" id="vad-threshold" class="form-control" min="0" max="1" step="0.05" value="0.2" onchange="onSettingChange()" data-restart-required="true">
                                <small class="form-text">值越小越敏感，越容易触发断句</small>
                            </div>

                            <div class="form-group">
                                <label for="vad-silence-duration">VAD静音持续时间（毫秒）</label>
                                <input type="number" id="vad-silence-duration" class="form-control" min="100" max="3000" step="100" value="800" onchange="onSettingChange()" data-restart-required="true">
                                <small class="form-text">检测到此时长的静音后触发断句</small>
                            </div>
                        </div>

                        <!-- WebSocket保活设置 -->
                        <div class="subsection">
                            <h3>WebSocket保活设置 - 仅Qwen后端</h3>
                            
                            <div class="form-group">
                                <label for="keepalive-interval">心跳间隔（秒）</label>
                                <input type="number" id="keepalive-interval" class="form-control" min="0" max="120" step="5" value="30" onchange="onSettingChange()" data-restart-required="true">
                                <small class="form-text">防止长时间闲置导致连接超时，设置为0禁用</small>
                            </div>
                        </div>

                        <!-- 语言检测器设置 -->
                        <div class="subsection">
                            <h3>语言检测器设置</h3>
                            
                            <div class="form-group">
                                <label for="language-detector">检测器类型</label>
                                <select id="language-detector" class="form-control" onchange="onSettingChange()">
                                    <option value="cjke">中日韩英检测器（推荐）</option>
                                    <option value="enzh">中英检测器</option>
                                    <option value="fasttext">通用检测器（支持更多语言）</option>
                                </select>
                            </div>
                        </div>

                        <!-- 源语言设置 -->
                        <div class="subsection">
                            <h3>源语言设置</h3>
                            
                            <div class="form-group">
                                <label for="source-language">源语言</label>
                                <select id="source-language" class="form-control" onchange="onSettingChange()">
                                    <option value="auto">自动检测</option>
                                    <option value="zh">中文</option>
                                    <option value="en">英语</option>
                                    <option value="ja">日语</option>
                                    <option value="ko">韩语</option>
                                </select>
                                <small class="form-text">建议保持"自动检测"</small>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <footer>
            <p>Yakutan | <a href="https://github.com/febilly/Yakutan" target="_blank">GitHub</a></p>
        </footer>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
